---
output: pdf_document
---

```{r setup, include=FALSE}
source('_chunk_setup.R')
```


# Teacher notes

5: Intro

- What are their aims for the module.
- What sorts of data do we want to analyse? Do you have your own data?
- Reflection on working styles/practices for learning R.


10:   What is the point of repeated measures? What benefits do we gain?

15:   Generate examples of repeated measures data.

20:   School exercise

30:   Schools feedback/discussion

35:   More schools, less information plot exercise

40:  Quick recap on mean and variance.... Sum of the squares. Std Deviation is sqrt of variance.   (Sample variance is N-1)

50:   Independent and identically distributed assumption. Ask them to generate examples which would/would not be IID

60: Break

70: Splitting the error graphs ... ask students to guess meaning

95: Explicitly go through splitting error term slide and intro to mixed models


105:   RCT example: Followup question: Given a fixed budget, would it become more or less important to sample as many different patients as possible, compared with sampling the same patients repeatedly?


115: Quick demo of reshaping and plotting the fit data.

Homework: Exercise online - reshaping data in prep for next week



### Schools notes


- Applied perspective -> no single right answer
- wouldn't pick one of the answers near the extremes because
- balancing different concerns:


These:

- Generalisability to all schools

- Practical/cost/time (although strictly this wasn't part of the question)

- Fair estimate for each school (because low scores could have consequences for teachers, if results were published)

- See if schools *vary* in how effective they are?


But this question was about estimating the **average effectiveness** across the whole of the UK. So it's really a question about how to maximise **power**.


Highlight that POWER is not always highest with highest N.... also have to think about $k$ (groups)


If students within schools are similar then ***we might gain more information*** when we sample from a new school, even though that costs us more and the total N goes down.

<!--
> A question that often comes up at this point is how many units are needed at each level. It is difficult to give specific advice but there are some general principles that are worth stating now. The key one is the target of inference: in other words, are the units in your dataset special ones that you are interested in in their own right, or are you regarding them as representatives of a larger population which you wish to use them to draw conclusions about? If the target of inference in an educational study is a particular school then you would need a lot of students in that school to get a precise effect. If the target of inference is between-school differences in general, then you would need a lot of schools to get a reliable estimate. That is, you could not sensibly use a multilevel model with only two schools even if you had a sample of 1000 students in each of them. In the educational literature it has been suggested that, given the size of effects that are commonly found for between-school differences, a minimum of 25 schools is needed to provide a precise estimate of between-school variance, with a preference for 100 or more schools[2]. You would not normally omit any school from the analysis merely because it has few students, but at the same time you will not be able to distinguish between-school and between-student variation if there is only one student in each and every school. Note that schools with only one pupil still add information to the estimates of the effects of the explanatory variables on the mean. There are, of course, some contexts where some or all of the higher-level units will have only a few lower-level units. An extreme and common case is when individuals are at level 1 and households are at level 2, because then the sample size within a level 2 unit is typically less than five people. This need not be a problem if the target of inference is households in general because the quality of estimates in this case is based on the total number of households in the sample and it should be possible to sample a large number of these. If the target of inference is a specific household, however, parameters will be poorly estimated because a single household has very few members. See Snijders and Bosker (1993)[3] for more details on sample size issues for multilevel models. -->





\clearpage




# Schools 1

Imagine you work for the UK Department for Education (DfE).

**Your task is to find out whether a new educational intervention is effective**. The new intervention has been rolled out in 1000 randomly-selected schools in the UK.

- You have a budget of around £10,000.
- The cost to visit a single school is £100
- The cost to measure each pupil is £10
- The average size of a school in the UK is roughly [250](https://www.theguardian.com/education/2013/may/17/primary-schools-supersize).

Would you prefer to collect data from:

```{r echo=F, results='asis'}
budget <- 10000
schoolcost  <- 100
kidcost <- 10
p  <- seq(.9,.1, -.1) # prop spent on schools
schools = as.integer(p*budget / schoolcost)
kids = as.integer((1-p)*budget / kidcost)
expand.grid(schools=seq(3,200,10), kids=1:1000) %>%
  as.tibble() %>%
  mutate(
    cost = kids*kidcost+schools*schoolcost)%>%
  filter(cost == budget & kids > schools)%>%
  group_by(schools)%>%
  arrange(-cost)%>%
  slice(1:1)%>%
  mutate(
    s = sprintf("%s children across %s schools",
      kids,
    schools
    )) %>%
pull(s) %>% pander::pandoc.list()
```

These options all cost around £10,000.

Discuss the problem as a small group. Identify the different tradeoffs involved.



\newpage


## Schools task 2


![](images/repeated-measures-schools-plot.pdf)


- Which schools would you most and least want to sample another child from? Why?

- Why would it be better to sample from another school, than another pupil from school in the set plotted?





\newpage


##  IID plots


Q: Are residuals equally likely to fall outside 2xSE for all values of X?

```{r, echo=F}
set.seed(123)
df <- tibble(x= rnorm(100))%>%rowwise() %>% mutate(y = rnorm(1,0,  2+.8*x))%>%ungroup()

homogvar.plot <- lm(y~x, data=df)%>%broom::augment()%>%
ggplot(aes(x, .resid)) +  geom_point() + geom_hline(yintercept =0) +
geom_line(aes(y = +2*.se.fit), color="red", linetype=2) +
geom_line(aes(y = -2*.se.fit), color="red", linetype=2)

ggsave('images/iid-homogvar.pdf', homogvar.plot)
homogvar.plot
```



Q: Are residuals equally spaced for different people?

```{r, echo=F}
set.seed(12345)
K = 5
n = 4
df <-
 tibble(y = rnorm(K*n),
  u = rep(rnorm(K, 0,.75), n),
  person = factor(u, labels=1:K),
  outcome = y+u)


indep.plot <- lm(outcome~1, data=df)%>%
broom::augment(., df) %>%
ggplot(aes(person, .resid, color=person)) + geom_point()  +
geom_hline(yintercept =0) + ylab("Residual") + xlab("Person")

ggsave('images/iid-independent.pdf', indep.plot)
indep.plot
```




\newpage



# Label the plots exercise


This plot shows 15 datapoints, for 3 individuals within a repeated measures study:


![](images/variance-components-1-nolines.pdf)

The x-axis could be anything; for this exercise it's not relevant, but is displayed to make the plot easier to read. If it helps, you can imagine it represents time of day.



Your job is to label each of the following plots (which use the same data), and indicate which of these concepts they illustrate:

- Total variance
- Variation between individuals
- Variation within individuals
- The relative proportion of variance within and between individuals.



![](images/variance-components-2-sumssquares.pdf)


![](images/variance-components-3-sumssquaresbetween.pdf)


![](images/variance-components-3-sumssquareswithin.pdf)


![](images/variance-components-3-sumssquareswithinandbetween.pdf)





\newpage



# RCT Example


Imagine these are data from a clinical trial for a treatment for depression.  We measured patients' depression in the year after they were treated.

The plot below shows 5 measurements taken from each person, during this year:

```{r echo=F}
set.seed(1234)
rctplot <- tibble(y = rnorm(100), u = rep(rnorm(20, 15, 3), 5),
  person = factor(u, labels=1:20),
  depression = y+u) %>%
ggplot(aes(person, depression)) + geom_point() + geom_jitter(width=.1)+
xlab("Patient (sorted by mean severity)") + ylab("Depression severity")
ggsave('images/repeat-measures-rctplot.pdf', rctplot)
rctplot
```


In the first study we only included women, and excluded patients with any medical or psychological comorbidities.

Now imagine we re-run the study, but change the entry criteria to recruit a much wider group of patients.


- How would this plot change?

- Would the total amount of variation in depression increase or decrease?

- Would there be more variation *within* or *between* patients, or both? Which would see the greater increase?
